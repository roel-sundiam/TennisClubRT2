<div class="manual-court-usage-container">
  <div class="header-section">
    <button mat-icon-button (click)="goBack()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Manual Court Usage</h1>
  </div>

  <mat-card class="form-card">
    <mat-card-header>
      <mat-icon mat-card-avatar>edit_calendar</mat-icon>
      <mat-card-title>Record Court Usage</mat-card-title>
      <mat-card-subtitle>Create pending payments for court usage</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="courtUsageForm" class="court-usage-form">
        <!-- Date and Time Selection -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Usage Date</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="date" required>
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error>Date is required</mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Start Time</mat-label>
            <mat-select formControlName="startTime" required>
              <mat-option *ngFor="let slot of timeSlots" [value]="slot.value">
                {{ slot.label }}
              </mat-option>
            </mat-select>
            <mat-error>Start time is required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>End Time</mat-label>
            <mat-select formControlName="endTime" required>
              <mat-option *ngFor="let slot of timeSlots" [value]="slot.value">
                {{ slot.label }}
              </mat-option>
            </mat-select>
            <mat-error>End time is required</mat-error>
            <mat-hint>Select the hour when the session ends</mat-hint>
          </mat-form-field>
        </div>

        <!-- Player Selection -->
        <div class="player-section">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Add Players</mat-label>
            <input
              matInput
              formControlName="playerInput"
              [matAutocomplete]="auto"
              (input)="onPlayerInputChange($event)"
              (keydown.enter)="addManualPlayer(); $event.preventDefault()"
              placeholder="Type player name and press Enter"
            >
            <button mat-icon-button matSuffix (click)="addManualPlayer()" type="button">
              <mat-icon>add</mat-icon>
            </button>
            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onMemberSelected($event)" [panelWidth]="'auto'">
              <mat-option *ngFor="let member of filteredMembers" [value]="member.fullName">
                {{ member.fullName }}
              </mat-option>
            </mat-autocomplete>
            <mat-hint>{{ filteredMembers.length }} member(s) available - Select from dropdown or type to search</mat-hint>
          </mat-form-field>

          <!-- Selected Players Chips -->
          <div class="selected-players" *ngIf="selectedPlayers.length > 0">
            <mat-chip-set>
              <mat-chip *ngFor="let player of selectedPlayers" (removed)="removePlayer(player)">
                {{ player }}
                <button matChipRemove>
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip>
            </mat-chip-set>
          </div>
        </div>

        <!-- Calculate Button -->
        <div class="action-row">
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="calculateFees()"
            [disabled]="selectedPlayers.length === 0 || !courtUsageForm.get('startTime')?.value || !courtUsageForm.get('endTime')?.value || calculating"
          >
            <mat-icon>calculate</mat-icon>
            Calculate Fees
          </button>
        </div>

        <!-- Player Payments Table -->
        <div class="payments-section" *ngIf="playerPayments.length > 0">
          <h3>Player Payments (Editable)</h3>
          <table mat-table [dataSource]="playerPayments" class="payments-table">
            <!-- Player Name Column -->
            <ng-container matColumnDef="playerName">
              <th mat-header-cell *matHeaderCellDef>Player Name</th>
              <td mat-cell *matCellDef="let payment">{{ payment.playerName }}</td>
            </ng-container>

            <!-- Amount Column -->
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef>Amount (₱)</th>
              <td mat-cell *matCellDef="let payment">
                <mat-form-field appearance="outline" class="amount-field">
                  <input
                    matInput
                    type="number"
                    [value]="payment.amount"
                    (input)="updatePlayerAmount(payment.playerName, $any($event.target).value)"
                    min="0"
                    step="0.01"
                  >
                </mat-form-field>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let payment">
                <button mat-icon-button color="warn" (click)="removePlayer(payment.playerName)" type="button">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>

          <!-- Total -->
          <div class="total-row">
            <strong>Total Amount:</strong>
            <span class="total-amount">₱{{ getTotalAmount().toFixed(2) }}</span>
          </div>
        </div>

        <!-- Description -->
        <mat-form-field appearance="outline" class="full-width" *ngIf="playerPayments.length > 0">
          <mat-label>Description (Optional)</mat-label>
          <input matInput formControlName="description" placeholder="E.g., Training session">
          <mat-hint>Add notes about this court usage</mat-hint>
        </mat-form-field>

        <!-- Submit Button -->
        <div class="submit-row" *ngIf="playerPayments.length > 0">
          <button
            mat-raised-button
            color="accent"
            type="button"
            (click)="submitCourtUsage()"
            [disabled]="!canSubmit() || loading"
          >
            <mat-spinner *ngIf="loading" diameter="20" class="inline-spinner"></mat-spinner>
            <mat-icon *ngIf="!loading">check_circle</mat-icon>
            {{ loading ? 'Creating...' : 'Create Pending Payments' }}
          </button>
          <button mat-button type="button" (click)="resetForm()" [disabled]="loading">
            <mat-icon>clear</mat-icon>
            Reset
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- History Section -->
  <mat-card class="history-card" *ngIf="history.length > 0">
    <mat-card-header>
      <mat-icon mat-card-avatar>history</mat-icon>
      <mat-card-title>Manual Court Usage History</mat-card-title>
      <mat-card-subtitle>{{ history.length }} record(s)</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <table mat-table [dataSource]="history" class="history-table">
        <!-- Date Column -->
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let session">{{ formatDate(session.date) }}</td>
        </ng-container>

        <!-- Time Slot Column -->
        <ng-container matColumnDef="timeSlot">
          <th mat-header-cell *matHeaderCellDef>Time</th>
          <td mat-cell *matCellDef="let session">{{ formatTimeSlot(session.timeSlot) }}</td>
        </ng-container>

        <!-- Players Column -->
        <ng-container matColumnDef="players">
          <th mat-header-cell *matHeaderCellDef>Players</th>
          <td mat-cell *matCellDef="let session">
            <span matTooltip="{{ getPlayersList(session.players) }}">
              {{ session.players.length }} player(s)
            </span>
          </td>
        </ng-container>

        <!-- Total Amount Column -->
        <ng-container matColumnDef="totalAmount">
          <th mat-header-cell *matHeaderCellDef>Total Amount</th>
          <td mat-cell *matCellDef="let session">₱{{ session.totalAmount.toFixed(2) }}</td>
        </ng-container>

        <!-- Created By Column -->
        <ng-container matColumnDef="createdBy">
          <th mat-header-cell *matHeaderCellDef>Created By</th>
          <td mat-cell *matCellDef="let session">{{ session.createdBy }}</td>
        </ng-container>

        <!-- Created At Column -->
        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>Created At</th>
          <td mat-cell *matCellDef="let session">{{ formatDate(session.createdAt) }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: historyColumns;"></tr>
      </table>
    </mat-card-content>
  </mat-card>
</div>
